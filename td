#!/usr/bin/env bash
# td v1.4 - VPS-Tailscale-DERP ç®¡ç†å·¥å…·
# ä½œè€…: bobvane
# å½©è‰²ç»ˆç«¯ + å®ç”¨ç®¡ç† + ä¸€é”®å¸è½½

RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
CYAN=$(tput setaf 6)
RESET=$(tput sgr0)

title(){
  echo -e "\n${CYAN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
  echo -e "${CYAN}â”‚ VPS-Tailscale-DERP ç®¡ç†å·¥å…· â”‚${RESET}"
  echo -e "${CYAN}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤${RESET}"
}

pause(){ read -rp $'\næŒ‰å›è½¦é”®è¿”å›èœå•...'; }

check_status(){
  systemctl is-active --quiet derper && echo "${GREEN}âœ” æ­£åœ¨è¿è¡Œ${RESET}" || echo "${RED}âœ˜ æœªè¿è¡Œ${RESET}"
}

status_menu(){
  echo -e "\n${YELLOW}ğŸ” DERP æœåŠ¡çŠ¶æ€:${RESET}"
  systemctl status derper --no-pager -l | grep -E 'Active|Main PID|Loaded'
  echo -e "\n${CYAN}ç›‘å¬ç«¯å£:${RESET}"
  ss -tuln | grep 443 || echo "æœªæ£€æµ‹åˆ°ç«¯å£ç›‘å¬"
  pause
}

restart_menu(){
  echo -e "\n${YELLOW}â™» æ­£åœ¨é‡å¯ DERP æœåŠ¡...${RESET}"
  systemctl restart derper && sleep 2
  echo -e "${GREEN}âœ… é‡å¯å®Œæˆ${RESET}"
  pause
}

log_menu(){
  echo -e "\n${YELLOW}ğŸ“œ æœ€è¿‘ 30 æ¡æ—¥å¿—:${RESET}\n"
  journalctl -u derper --no-pager -n 30
  pause
}

ssl_renew_menu(){
  echo -e "\n${YELLOW}ğŸ” é‡æ–°ç”³è¯· SSL è¯ä¹¦...${RESET}"
  systemctl stop derper
  rm -rf /var/lib/derper/certs/*
  systemctl start derper
  sleep 5
  [[ -f /var/lib/derper/certs/*.crt ]] && echo "${GREEN}âœ… è¯ä¹¦æ›´æ–°æˆåŠŸ${RESET}" || echo "${RED}âŒ è¯ä¹¦ç”³è¯·å¤±è´¥${RESET}"
  pause
}

uninstall_menu(){
  echo -e "\n${RED}âš ï¸ å½»åº•å¸è½½ DERP + Go ç¯å¢ƒ + td${RESET}"
  read -rp "ç¡®è®¤ç»§ç»­ï¼Ÿ(y/N): " yn
  [[ "$yn" != [Yy] ]] && return
  systemctl stop derper 2>/dev/null || true
  systemctl disable derper 2>/dev/null || true
  rm -f /etc/systemd/system/derper.service
  systemctl daemon-reload
  killall derper 2>/dev/null || true
  rm -rf /opt/derper /var/lib/derper /usr/local/bin/derper /usr/local/go /etc/profile.d/99-go-path.sh
  rm -f /usr/local/bin/td
  echo -e "${GREEN}âœ… å¸è½½å®Œæˆ${RESET}"
  pause
  exit 0
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¸»èœå• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
while true; do
  clear
  title
  echo -e "DERP çŠ¶æ€ï¼š$(check_status)\n"
  echo "1) æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
  echo "2) é‡å¯ DERP æœåŠ¡"
  echo "3) æŸ¥çœ‹è¿è¡Œæ—¥å¿—"
  echo "4) é‡æ–°ç”³è¯· SSL è¯ä¹¦"
  echo "5) å¸è½½ DERP + Go ç¯å¢ƒ"
  echo -e "${CYAN}0) é€€å‡º${RESET}"
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  read -rp "è¯·é€‰æ‹©æ“ä½œç¼–å·: " opt
  case "$opt" in
    1) status_menu ;;
    2) restart_menu ;;
    3) log_menu ;;
    4) ssl_renew_menu ;;
    5) uninstall_menu ;;
    0) echo "å†è§ï¼Œå°‘å¹´ï¼"; exit 0 ;;
    *) echo "${RED}æ— æ•ˆé€‰é¡¹${RESET}"; sleep 1 ;;
  esac
done

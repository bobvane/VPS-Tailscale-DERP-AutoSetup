#!/usr/bin/env bash
# td v2.0 - ç²¾ç®€ç‰ˆ DERP ç®¡ç†å·¥å…·ï¼ˆäº¤äº’å¼ï¼‰
set -euo pipefail
export LANG=zh_CN.UTF-8

# Colors
RED=$(tput setaf 1 2>/dev/null || echo "")
GREEN=$(tput setaf 2 2>/dev/null || echo "")
YELLOW=$(tput setaf 3 2>/dev/null || echo "")
CYAN=$(tput setaf 6 2>/dev/null || echo "")
RESET=$(tput sgr0 2>/dev/null || echo "")

info(){ echo -e "${GREEN}[INFO]${RESET} $*"; }
warn(){ echo -e "${YELLOW}[WARN]${RESET} $*"; }
err(){ echo -e "${RED}[ERROR]${RESET} $*"; }

DERP_SERVICE="derper"
TAILSCALE_SERVICE="tailscaled"
DERP_CERTDIR="/var/lib/derper/certs"
DERP_SYSTEMD_UNIT="/etc/systemd/system/derper.service"
DERPMAP_PATH="/etc/tailscale/derpmap.json"
CRON_FILE="/etc/cron.d/derper-renew"

_pause(){ read -rp $'\næŒ‰å›è½¦è¿”å›èœå•'; }

# è§£æ ExecStart ä¸­çš„ hostname
get_derp_hostname(){
    if [[ -f "${DERP_SYSTEMD_UNIT}" ]]; then
        awk -F'--hostname ' '/ExecStart/ {print $2; exit}' "${DERP_SYSTEMD_UNIT}" | awk '{print $1}' || true
    else
        echo ""
    fi
}

DERP_DEFAULT_HOSTNAME="$(get_derp_hostname)"
DERP_IP="$(dig +short "${DERP_DEFAULT_HOSTNAME:-}" A 2>/dev/null | tail -n1 || true)"

show_header(){
    clear
    echo -e "${CYAN}=== td v2.0 â€” DERP ç®¡ç†å·¥å…· ===${RESET}"
    echo
}

menu(){
    show_header
    echo "1) æŸ¥çœ‹ DERP æœåŠ¡çŠ¶æ€"
    echo "2) é‡å¯ DERPï¼ˆå¹¶æ˜¾ç¤ºçŠ¶æ€ä¸æ—¥å¿—ï¼‰"
    echo "3) åœæ­¢ DERPï¼ˆå¹¶æ˜¾ç¤ºçŠ¶æ€ï¼‰"
    echo "4) ç”Ÿæˆ DERP Mapï¼ˆåœ¨ç•Œé¢æ˜¾ç¤ºï¼Œä¾¿äºå¤åˆ¶ï¼‰"
    echo "5) æŸ¥çœ‹è¯ä¹¦ä¸åˆ°æœŸæ—¶é—´"
    echo "6) å¸è½½æœ¬é¡¹ç›®ï¼ˆå½»åº•ã€å¸¦å¤‡ä»½ï¼‰"
    echo "0) é€€å‡º"
    echo
    read -rp "è¯·é€‰æ‹©: " opt
    case "$opt" in
        1) status_derp ;;
        2) restart_derp ;;
        3) stop_derp ;;
        4) gen_derpmap ;;
        5) show_cert ;;
        6) uninstall_project ;;
        0) exit 0 ;;
        *) echo "æ— æ•ˆé€‰é¡¹"; _pause; menu ;;
    esac
}

status_derp(){
    show_header
    echo -e "${CYAN}-- DERP æœåŠ¡çŠ¶æ€ --${RESET}"
    if systemctl status "${DERP_SERVICE}" >/dev/null 2>&1; then
        systemctl status "${DERP_SERVICE}" --no-pager || true
        echo
        echo -e "${CYAN}æœ€å 20 è¡Œæ—¥å¿—:${RESET}"
        journalctl -u "${DERP_SERVICE}" -n 20 --no-pager || true
    else
        warn "æœªæ£€æµ‹åˆ° ${DERP_SERVICE}.service"
    fi
    _pause; menu
}

restart_derp(){
    show_header
    info "æ­£åœ¨é‡å¯ ${DERP_SERVICE}..."
    if systemctl cat "${DERP_SERVICE}" >/dev/null 2>&1; then
        sudo systemctl restart "${DERP_SERVICE}" || warn "é‡å¯å¤±è´¥"
        sleep 1
        echo
        echo -e "${CYAN}æœ€æ–°çŠ¶æ€:${RESET}"
        systemctl status "${DERP_SERVICE}" --no-pager || true
        echo
        echo -e "${CYAN}æœ€è¿‘ 20 è¡Œæ—¥å¿—:${RESET}"
        journalctl -u "${DERP_SERVICE}" -n 20 --no-pager || true
    else
        err "æœªæ‰¾åˆ° ${DERP_SERVICE}.service"
    fi
    _pause; menu
}

stop_derp(){
    show_header
    info "æ­£åœ¨åœæ­¢ ${DERP_SERVICE}..."
    if systemctl cat "${DERP_SERVICE}" >/dev/null 2>&1; then
        sudo systemctl stop "${DERP_SERVICE}" || warn "åœæ­¢å¤±è´¥"
        sleep 1
        echo
        echo -e "${CYAN}å½“å‰æœåŠ¡çŠ¶æ€:${RESET}"
        systemctl status "${DERP_SERVICE}" --no-pager || true

        if systemctl is-active --quiet "${DERP_SERVICE}"; then
            warn "æœåŠ¡ä»åœ¨è¿è¡Œï¼Œå¯èƒ½è¢«è‡ªåŠ¨é‡å¯"
        else
            info "å·²åœæ­¢"
        fi
    else
        warn "æœªæ£€æµ‹åˆ° ${DERP_SERVICE}.service"
    fi
    _pause; menu
}

is_ipv4(){
    local ip=$1
    if [[ -z "$ip" ]]; then return 1; fi
    if echo "$ip" | grep -E -q '^([0-9]{1,3}\.){3}[0-9]{1,3}$'; then
        IFS='.' read -r a b c d <<< "$ip"
        for x in $a $b $c $d; do
            (( x>=0 && x<=255 )) || return 1
        done
        return 0
    fi
    return 1
}

gen_derpmap(){
    show_header
    echo -e "${CYAN}ç”Ÿæˆå®Œæ•´ DERP ACL JSONï¼ˆå¯ç›´æ¥æ›¿æ¢æ§åˆ¶å°å…¨éƒ¨å†…å®¹ï¼‰${RESET}"

    # ---------------------------
    # è‡ªåŠ¨æ£€æµ‹é»˜è®¤ Region å€¼
    # ---------------------------
    read -rp "RegionIDï¼ˆé»˜è®¤: 900ï¼Œå›è½¦é‡‡ç”¨ï¼Œè¾“å…¥ä¿®æ”¹ï¼‰: " regionid
    regionid=${regionid:-900}

    read -rp "RegionCodeï¼ˆé»˜è®¤: CNï¼Œå›è½¦é‡‡ç”¨ï¼Œè¾“å…¥ä¿®æ”¹ï¼‰: " regioncode
    regioncode=${regioncode:-CN}

    read -rp "RegionNameï¼ˆé»˜è®¤: DERP-CNï¼Œå›è½¦é‡‡ç”¨ï¼Œè¾“å…¥ä¿®æ”¹ï¼‰: " regionname
    regionname=${regionname:-"DERP-CN"}

    # ---------------------------
    # è‡ªåŠ¨æ£€æµ‹ DERP ä¸»æœºå
    # ä¼˜å…ˆé¡ºåºï¼š
    #   1. systemd --hostname
    #   2. /etc/letsencrypt/live/*
    #   3. fallback: derp.example.com
    # ---------------------------
    detect_hostname=""

    # 1) ä» systemd å–
    detect_hostname=$(get_derp_hostname || true)

    # 2) ä»è¯ä¹¦ç›®å½• fallback
    if [[ -z "$detect_hostname" ]]; then
        le_dir=$(find /etc/letsencrypt/live -maxdepth 1 -mindepth 1 -type d 2>/dev/null | head -n1)
        if [[ -n "$le_dir" ]]; then
            detect_hostname=$(basename "$le_dir")
        fi
    fi

    # 3) fallback
    detect_hostname=${detect_hostname:-"derp.example.com"}

    read -rp "DERP ä¸»æœºåï¼ˆé»˜è®¤: ${detect_hostname}ï¼Œå›è½¦é‡‡ç”¨ï¼Œè¾“å…¥ä¿®æ”¹ï¼‰: " host
    host=${host:-$detect_hostname}

    # ---------------------------
    # è‡ªåŠ¨æ£€æµ‹å…¬ç½‘ IPv4
    #   ä¼˜å…ˆä» DNS è§£æ hostname
    #   å† fallback å…¬ç½‘ IP
    # ---------------------------
    ip_from_dns=$(dig +short "$host" A 2>/dev/null | tail -n1)
    if [[ -n "$ip_from_dns" ]]; then
        default_ip="$ip_from_dns"
    else
        # fallbackï¼šè·å–çœŸå®å…¬ç½‘ IP
        default_ip=$(curl -4s https://ipinfo.io/ip 2>/dev/null)
        # å† fallbackï¼šhostname -I
        default_ip=${default_ip:-$(hostname -I | awk '{print $1}')}
    fi
    default_ip=${default_ip:-"0.0.0.0"}

    read -rp "DERP IPv4ï¼ˆé»˜è®¤: ${default_ip}ï¼Œå›è½¦é‡‡ç”¨ï¼Œè¾“å…¥ä¿®æ”¹ï¼‰: " ip
    ip=${ip:-$default_ip}

    # ---------------------------
    # è¾“å‡ºå®Œæ•´ ACL JSON
    # ---------------------------
cat <<EOF

================================================================================
âš  è¯·å¤åˆ¶ä¸‹é¢æ‰€æœ‰å†…å®¹ï¼Œå¹¶ç²˜è´´åˆ°æ§åˆ¶å°ä¸­å®Œå…¨æ›¿æ¢å½“å‰ JSONï¼
æ§åˆ¶å°é“¾æ¥ï¼š
ğŸ‘‰ https://login.tailscale.com/admin/acls/file

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´å¯ç”¨çš„ ACL + DERP Map é…ç½®æ–‡ä»¶ï¼Œä¿å­˜å³å¯ç«‹å³ç”Ÿæ•ˆã€‚
================================================================================


{
  "derpMap": {
    "OmitDefaultRegions": true,
    "Regions": {
      "${regionid}": {
        "RegionID": ${regionid},
        "RegionCode": "${regioncode}",
        "RegionName": "${regionname}",
        "Nodes": [
          {
            "Name": "${host}",
            "RegionID": ${regionid},
            "HostName": "${host}",
            "IPv4": "${ip}",
            "STUNPort": 3478,
            "DERPPort": 443
          }
        ]
      }
    }
  },

  "acls": [
    {
      "action": "accept",
      "src": ["*"],
      "dst": ["*:*"]
    }
  ],

  "ssh": []
}

================================================================================
âš  å®Œæ•´ JSON åˆ°æ­¤ç»“æŸã€‚
ç²˜è´´ â†’ ä¿å­˜ â†’ ç«‹å³ç”Ÿæ•ˆ
================================================================================

EOF

    _pause
    menu
}

show_cert(){
    show_header
    echo -e "${CYAN}è¯ä¹¦æ£€æµ‹${RESET}"

    local found=0

    # Let's Encrypt
    if [[ -n "${DERP_DEFAULT_HOSTNAME}" ]]; then
        local lepath="/etc/letsencrypt/live/${DERP_DEFAULT_HOSTNAME}/fullchain.pem"
        if [[ -f "$lepath" ]]; then
            info "æ£€æµ‹åˆ° Letâ€™s Encrypt è¯ä¹¦"
            openssl x509 -in "$lepath" -noout -subject -dates -text || true
            found=1
        fi
    fi

    # local certdir
    if [[ -d "$DERP_CERTDIR" ]]; then
        certs=("$DERP_CERTDIR"/*.crt)
        if [[ -e "${certs[0]}" ]]; then
            info "æ£€æµ‹åˆ° derper æœ¬åœ°è¯ä¹¦"
            for c in "${certs[@]}"; do
                openssl x509 -in "$c" -noout -subject -dates -text || true
            done
            found=1
        fi
    fi

    [[ $found -eq 0 ]] && warn "æœªæ‰¾åˆ°å¯è¯†åˆ«è¯ä¹¦"

    _pause; menu
}

uninstall_project(){
    show_header
    echo -e "${YELLOW}å°†å¸è½½æœ¬é¡¹ç›®å¹¶å¤‡ä»½${RESET}"
    read -rp "è¾“å…¥ yes ç¡®è®¤æ“ä½œ: " yn
    [[ "$yn" != "yes" ]] && { info "å–æ¶ˆ"; _pause; menu; }

    backup_dir="/root/td-derper-backup-$(date +%Y%m%d%H%M%S)"
    sudo mkdir -p "$backup_dir"
    info "å¤‡ä»½ç›®å½•: $backup_dir"

    # stop & disable derper
    if systemctl list-units --type=service --all | grep -q "^${DERP_SERVICE}.service"; then
        sudo systemctl stop "$DERP_SERVICE" || true
        sudo systemctl disable "$DERP_SERVICE" || true
        [[ -f "$DERP_SYSTEMD_UNIT" ]] && sudo cp "$DERP_SYSTEMD_UNIT" "$backup_dir" && sudo rm -f "$DERP_SYSTEMD_UNIT"
    fi

    # stop & disable tailscaled
    if systemctl list-units --type=service --all | grep -q "^${TAILSCALE_SERVICE}.service"; then
        sudo systemctl stop "$TAILSCALE_SERVICE" || true
        sudo systemctl disable "$TAILSCALE_SERVICE" || true
    fi

    sudo systemctl daemon-reload || true

    for p in /usr/local/bin/derper /usr/local/bin/td /opt/derper /var/lib/derper "$DERPMAP_PATH" "$CRON_FILE"; do
        [[ -e "$p" ]] && sudo cp -r "$p" "$backup_dir" && sudo rm -rf "$p"
    done

    info "å¸è½½å®Œæˆï¼Œå¤‡ä»½åœ¨: $backup_dir"
    _pause; menu
}

# main
menu

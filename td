#!/usr/bin/env bash
# td v1.3 - VPS-Tailscale-DERP-AutoSetup ç®¡ç†å·¥å…·
set -e

green(){ echo -e "\033[1;32m$1\033[0m"; }
yellow(){ echo -e "\033[1;33m$1\033[0m"; }
red(){ echo -e "\033[1;31m$1\033[0m"; }

menu(){
  clear
  green "========= VPS-Tailscale-DERP ç®¡ç†èœå• ========="
  echo "1. æŸ¥çœ‹ derper çŠ¶æ€"
  echo "2. é‡å¯ derper æœåŠ¡"
  echo "3. åœæ­¢ derper æœåŠ¡"
  echo "4. é‡æ–°ç”³è¯· SSL è¯ä¹¦"
  echo "5. ä¿®æ”¹ç»‘å®šåŸŸå"
  echo "6. å¸è½½æ­¤é¡¹ç›®ï¼ˆå½»åº•æ¸…ç†ï¼‰"
  echo "0. é€€å‡º"
  echo "==============================================="
  read -rp "è¯·é€‰æ‹©æ“ä½œ: " choice

  case $choice in
    1) systemctl status derper ;;
    2) systemctl restart derper; green "âœ… å·²é‡å¯ derper" ;;
    3) systemctl stop derper; green "ğŸ›‘ å·²åœæ­¢ derper" ;;
    4) systemctl stop derper; rm -rf /root/.cache/letsencrypt; systemctl restart derper; green "ğŸ”„ SSL è¯ä¹¦å·²é‡æ–°ç”³è¯·" ;;
    5) read -rp "è¾“å…¥æ–°çš„åŸŸå: " newdom
       sed -i "s/--hostname .*/--hostname ${newdom} --certmode letsencrypt --stun --a \":443\"/" /etc/systemd/system/derper.service
       systemctl daemon-reload; systemctl restart derper
       green "âœ… å·²æ›´æ–°ç»‘å®šåŸŸåä¸º ${newdom}" ;;
    6) uninstall ;;
    0) exit 0 ;;
    *) red "æ— æ•ˆé€‰é¡¹";;
  esac
  read -rp "æŒ‰å›è½¦è¿”å›èœå•..." temp
  menu
}

uninstall(){
  yellow "âš ï¸ ç¡®è®¤è¦å½»åº•å¸è½½ VPS-Tailscale-DERP å—ï¼Ÿ(y/n)"
  read -rp "> " yn
  [[ "$yn" != "y" && "$yn" != "Y" ]] && return

  echo "ğŸ§¹ æ­£åœ¨å¸è½½..."
  systemctl stop derper 2>/dev/null || true
  systemctl disable derper 2>/dev/null || true
  rm -f /etc/systemd/system/derper.service
  systemctl daemon-reload
  rm -rf /opt/derper /tmp/tailscale-src /usr/local/bin/derper /usr/local/bin/derper-autoupdate.sh
  rm -rf /usr/local/go /tmp/go.tar.gz /etc/profile.d/go-path.sh
  sed -i '/go\/bin/d' ~/.bashrc 2>/dev/null || true
  rm -f /etc/apt/sources.list.d/tailscale.list /usr/share/keyrings/tailscale-archive-keyring.gpg
  apt remove -y tailscale tailscale-archive-keyring >/dev/null 2>&1 || true
  apt autoremove -y >/dev/null 2>&1 || true
  rm -f /usr/local/bin/td
  green "âœ… å¸è½½å®Œæˆï¼Œç³»ç»Ÿå·²æ¸…ç†å¹²å‡€ã€‚"
}

menu

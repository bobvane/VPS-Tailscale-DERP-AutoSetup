#!/usr/bin/env bash
# td v2.0 - ç²¾ç®€ç‰ˆ DERP ç®¡ç†å·¥å…·ï¼ˆäº¤äº’å¼ï¼‰
set -euo pipefail
export LANG=zh_CN.UTF-8

# Colors
RED=$(tput setaf 1 2>/dev/null || echo "")
GREEN=$(tput setaf 2 2>/dev/null || echo "")
YELLOW=$(tput setaf 3 2>/dev/null || echo "")
CYAN=$(tput setaf 6 2>/dev/null || echo "")
RESET=$(tput sgr0 2>/dev/null || echo "")

info(){ echo -e "${GREEN}[INFO]${RESET} $*"; }
warn(){ echo -e "${YELLOW}[WARN]${RESET} $*"; }
err(){ echo -e "${RED}[ERROR]${RESET} $*"; }

DERP_SERVICE="derper"
TAILSCALE_SERVICE="tailscaled"
DERP_CERTDIR="/var/lib/derper/certs"
DERP_SYSTEMD_UNIT="/etc/systemd/system/derper.service"
DERPMAP_PATH="/etc/tailscale/derpmap.json"
CRON_FILE="/etc/cron.d/derper-renew"

_pause(){ read -rp $'\næŒ‰å›è½¦è¿”å›èœå•'; }

# è§£æ ExecStart ä¸­çš„ hostname
get_derp_hostname(){
    if [[ -f "${DERP_SYSTEMD_UNIT}" ]]; then
        awk -F'--hostname ' '/ExecStart/ {print $2; exit}' "${DERP_SYSTEMD_UNIT}" | awk '{print $1}' || true
    else
        echo ""
    fi
}

DERP_DEFAULT_HOSTNAME="$(get_derp_hostname)"
DERP_IP="$(dig +short "${DERP_DEFAULT_HOSTNAME:-}" A 2>/dev/null | tail -n1 || true)"

show_header(){
    clear
    echo -e "${CYAN}=== td v2.0 â€” DERP ç®¡ç†å·¥å…· ===${RESET}"
    echo
}

menu(){
    show_header
    echo "1) æŸ¥çœ‹ DERP æœåŠ¡çŠ¶æ€"
    echo "2) é‡å¯ DERPï¼ˆå¹¶æ˜¾ç¤ºçŠ¶æ€ä¸æ—¥å¿—ï¼‰"
    echo "3) åœæ­¢ DERPï¼ˆå¹¶æ˜¾ç¤ºçŠ¶æ€ï¼‰"
    echo "4) ç”Ÿæˆ DERP Mapï¼ˆåœ¨ç•Œé¢æ˜¾ç¤ºï¼Œä¾¿äºå¤åˆ¶ï¼‰"
    echo "5) æŸ¥çœ‹è¯ä¹¦ä¸åˆ°æœŸæ—¶é—´"
    echo "6) å¸è½½æœ¬é¡¹ç›®ï¼ˆå½»åº•ã€å¸¦å¤‡ä»½ï¼‰"
    echo "0) é€€å‡º"
    echo
    read -rp "è¯·é€‰æ‹©: " opt
    case "$opt" in
        1) status_derp ;;
        2) restart_derp ;;
        3) stop_derp ;;
        4) gen_derpmap ;;
        5) show_cert ;;
        6) uninstall_project ;;
        0) exit 0 ;;
        *) echo "æ— æ•ˆé€‰é¡¹"; _pause; menu ;;
    esac
}

status_derp(){
    show_header
    echo -e "${CYAN}-- DERP æœåŠ¡çŠ¶æ€ --${RESET}"
    if systemctl status "${DERP_SERVICE}" >/dev/null 2>&1; then
        systemctl status "${DERP_SERVICE}" --no-pager || true
        echo
        echo -e "${CYAN}æœ€å 20 è¡Œæ—¥å¿—:${RESET}"
        journalctl -u "${DERP_SERVICE}" -n 20 --no-pager || true
    else
        warn "æœªæ£€æµ‹åˆ° ${DERP_SERVICE}.service"
    fi
    _pause; menu
}

restart_derp(){
    show_header
    info "æ­£åœ¨é‡å¯ ${DERP_SERVICE}..."
    if systemctl cat "${DERP_SERVICE}" >/dev/null 2>&1; then
        sudo systemctl restart "${DERP_SERVICE}" || warn "é‡å¯å¤±è´¥"
        sleep 1
        echo
        echo -e "${CYAN}æœ€æ–°çŠ¶æ€:${RESET}"
        systemctl status "${DERP_SERVICE}" --no-pager || true
        echo
        echo -e "${CYAN}æœ€è¿‘ 20 è¡Œæ—¥å¿—:${RESET}"
        journalctl -u "${DERP_SERVICE}" -n 20 --no-pager || true
    else
        err "æœªæ‰¾åˆ° ${DERP_SERVICE}.service"
    fi
    _pause; menu
}

stop_derp(){
    show_header
    info "æ­£åœ¨åœæ­¢ ${DERP_SERVICE}..."
    if systemctl cat "${DERP_SERVICE}" >/dev/null 2>&1; then
        sudo systemctl stop "${DERP_SERVICE}" || warn "åœæ­¢å¤±è´¥"
        sleep 1
        echo
        echo -e "${CYAN}å½“å‰æœåŠ¡çŠ¶æ€:${RESET}"
        systemctl status "${DERP_SERVICE}" --no-pager || true

        if systemctl is-active --quiet "${DERP_SERVICE}"; then
            warn "æœåŠ¡ä»åœ¨è¿è¡Œï¼Œå¯èƒ½è¢«è‡ªåŠ¨é‡å¯"
        else
            info "å·²åœæ­¢"
        fi
    else
        warn "æœªæ£€æµ‹åˆ° ${DERP_SERVICE}.service"
    fi
    _pause; menu
}

is_ipv4(){
    local ip=$1
    if [[ -z "$ip" ]]; then return 1; fi
    if echo "$ip" | grep -E -q '^([0-9]{1,3}\.){3}[0-9]{1,3}$'; then
        IFS='.' read -r a b c d <<< "$ip"
        for x in $a $b $c $d; do
            (( x>=0 && x<=255 )) || return 1
        done
        return 0
    fi
    return 1
}

gen_derpmap(){
    show_header
    echo -e "${CYAN}ç”Ÿæˆå®Œæ•´ DERP ACL JSONï¼ˆå¯ç›´æ¥æ›¿æ¢æ§åˆ¶å°å…¨éƒ¨å†…å®¹ï¼‰${RESET}"

    # ---------------------------
    # è‡ªåŠ¨æ£€æµ‹é»˜è®¤ Region å€¼
    # ---------------------------
    read -rp "RegionIDï¼ˆé»˜è®¤: 900ï¼Œå›è½¦é‡‡ç”¨ï¼Œè¾“å…¥ä¿®æ”¹ï¼‰: " regionid
    regionid=${regionid:-900}

    read -rp "RegionCodeï¼ˆé»˜è®¤: CNï¼Œå›è½¦é‡‡ç”¨ï¼Œè¾“å…¥ä¿®æ”¹ï¼‰: " regioncode
    regioncode=${regioncode:-CN}

    read -rp "RegionNameï¼ˆé»˜è®¤: DERP-CNï¼Œå›è½¦é‡‡ç”¨ï¼Œè¾“å…¥ä¿®æ”¹ï¼‰: " regionname
    regionname=${regionname:-"DERP-CN"}

    # ---------------------------
    # è‡ªåŠ¨æ£€æµ‹ DERP ä¸»æœºå
    # ä¼˜å…ˆé¡ºåºï¼š
    #   1. systemd --hostname
    #   2. /etc/letsencrypt/live/*
    #   3. fallback: derp.example.com
    # ---------------------------
    detect_hostname=""

    # 1) ä» systemd å–
    detect_hostname=$(get_derp_hostname || true)

    # 2) ä»è¯ä¹¦ç›®å½• fallback
    if [[ -z "$detect_hostname" ]]; then
        le_dir=$(find /etc/letsencrypt/live -maxdepth 1 -mindepth 1 -type d 2>/dev/null | head -n1)
        if [[ -n "$le_dir" ]]; then
            detect_hostname=$(basename "$le_dir")
        fi
    fi

    # 3) fallback
    detect_hostname=${detect_hostname:-"derp.example.com"}

    read -rp "DERP ä¸»æœºåï¼ˆé»˜è®¤: ${detect_hostname}ï¼Œå›è½¦é‡‡ç”¨ï¼Œè¾“å…¥ä¿®æ”¹ï¼‰: " host
    host=${host:-$detect_hostname}

    # ---------------------------
    # è‡ªåŠ¨æ£€æµ‹å…¬ç½‘ IPv4
    #   ä¼˜å…ˆä» DNS è§£æ hostname
    #   å† fallback å…¬ç½‘ IP
    # ---------------------------
    ip_from_dns=$(dig +short "$host" A 2>/dev/null | tail -n1)
    if [[ -n "$ip_from_dns" ]]; then
        default_ip="$ip_from_dns"
    else
        # fallbackï¼šè·å–çœŸå®å…¬ç½‘ IP
        default_ip=$(curl -4s https://ipinfo.io/ip 2>/dev/null)
        # å† fallbackï¼šhostname -I
        default_ip=${default_ip:-$(hostname -I | awk '{print $1}')}
    fi
    default_ip=${default_ip:-"0.0.0.0"}

    read -rp "DERP IPv4ï¼ˆé»˜è®¤: ${default_ip}ï¼Œå›è½¦é‡‡ç”¨ï¼Œè¾“å…¥ä¿®æ”¹ï¼‰: " ip
    ip=${ip:-$default_ip}

    # ---------------------------
    # è¾“å‡ºå®Œæ•´ ACL JSON
    # ---------------------------
cat <<EOF

================================================================================
âš  è¯·å¤åˆ¶ä¸‹é¢æ‰€æœ‰å†…å®¹ï¼Œå¹¶ç²˜è´´åˆ°æ§åˆ¶å°ä¸­å®Œå…¨æ›¿æ¢å½“å‰ JSONï¼
æ§åˆ¶å°é“¾æ¥ï¼š
ğŸ‘‰ https://login.tailscale.com/admin/acls/file

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´å¯ç”¨çš„ ACL + DERP Map é…ç½®æ–‡ä»¶ï¼Œä¿å­˜å³å¯ç«‹å³ç”Ÿæ•ˆã€‚
================================================================================


{
  "derpMap": {
    "OmitDefaultRegions": true,
    "Regions": {
      "${regionid}": {
        "RegionID": ${regionid},
        "RegionCode": "${regioncode}",
        "RegionName": "${regionname}",
        "Nodes": [
          {
            "Name": "${host}",
            "RegionID": ${regionid},
            "HostName": "${host}",
            "IPv4": "${ip}",
            "STUNPort": 3478,
            "DERPPort": 443
          }
        ]
      }
    }
  },

  "acls": [
    {
      "action": "accept",
      "src": ["*"],
      "dst": ["*:*"]
    }
  ],

  "ssh": []
}

================================================================================
âš  å®Œæ•´ JSON åˆ°æ­¤ç»“æŸã€‚
ç²˜è´´ â†’ ä¿å­˜ â†’ ç«‹å³ç”Ÿæ•ˆ
================================================================================

EOF

    _pause
    menu
}

show_cert(){
    show_header
    echo -e "${CYAN}è¯ä¹¦æ£€æµ‹ï¼ˆDERP ä½¿ç”¨è¯ä¹¦ + Letâ€™s Encrypt æºè¯ä¹¦ï¼‰${RESET}"
    local found=0

    # --- å°† openssl æ—¥æœŸè½¬æ¢ä¸ºä¸­æ–‡æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ ---
    format_cn_time(){
        raw="$1"
        date -d "$raw" +"%Y-%m-%d %H:%M:%S" 2>/dev/null || echo "$raw"
    }

    # --- è®¡ç®—è¿‡æœŸå¤©æ•° ---
    calc_days_remaining(){
        end_raw="$1"
        end_ts=$(date -d "$end_raw" +%s 2>/dev/null || echo 0)
        now_ts=$(date +%s)
        echo $(( (end_ts - now_ts) / 86400 ))
    }

    # --- è¾“å‡ºè¯ä¹¦ä¿¡æ¯ï¼ˆä¸»ä½“ + æ—¶é—´ + å‰©ä½™å¤©æ•°ï¼‰ ---
    print_cert_info(){
        cert_file="$1"

        # æå–å¿…éœ€å­—æ®µ
        subject=$(openssl x509 -in "$cert_file" -noout -subject 2>/dev/null | sed 's/subject=//')

        nb_raw=$(openssl x509 -in "$cert_file" -noout -startdate 2>/dev/null | cut -d= -f2)
        na_raw=$(openssl x509 -in "$cert_file" -noout -enddate   2>/dev/null | cut -d= -f2)

        nb_cn=$(format_cn_time "$nb_raw")
        na_cn=$(format_cn_time "$na_raw")

        days_left=$(calc_days_remaining "$na_raw")

        # é¢œè‰²æç¤º
        if (( days_left < 0 )); then
            status="${RED}å·²è¿‡æœŸï¼${RESET}"
        elif (( days_left <= 7 )); then
            status="${RED}å³å°†è¿‡æœŸï¼ˆå‰©ä½™ ${days_left} å¤©ï¼‰${RESET}"
        elif (( days_left <= 30 )); then
            status="${YELLOW}å®‰å…¨æœŸè¾ƒçŸ­ï¼ˆå‰©ä½™ ${days_left} å¤©ï¼‰${RESET}"
        else
            status="${GREEN}å®‰å…¨ï¼ˆå‰©ä½™ ${days_left} å¤©ï¼‰${RESET}"
        fi

        echo -e "${CYAN}è¯ä¹¦æ–‡ä»¶:${RESET} $cert_file"
        echo -e "  ä¸»ä½“ä¿¡æ¯: ${subject}"
        echo -e "  ç”Ÿæ•ˆæ—¶é—´: ${nb_cn}"
        echo -e "  åˆ°æœŸæ—¶é—´: ${na_cn}"
        echo -e "  å½“å‰çŠ¶æ€: ${status}"
        echo
    }

    # ---------------------------
    # 1) æ£€æµ‹ DERP å®é™…ä½¿ç”¨è¯ä¹¦ (/etc/derp/certs)
    # ---------------------------
    if [[ -d "/etc/derp/certs" ]]; then
        certs=(/etc/derp/certs/*.crt)
        if [[ -e "${certs[0]}" ]]; then
            info "æ£€æµ‹åˆ° DERP ä½¿ç”¨çš„è¯ä¹¦ç›®å½•: /etc/derp/certs"
            for c in /etc/derp/certs/*.crt; do
                print_cert_info "$c"
            done
            found=1
        fi
    fi

    # ---------------------------
    # 2) æ£€æµ‹ Letâ€™s Encrypt è¯ä¹¦
    # ---------------------------
    if compgen -G "/etc/letsencrypt/live/*/fullchain.pem" >/dev/null; then
        for p in /etc/letsencrypt/live/*/fullchain.pem; do
            domain=$(basename "$(dirname "$p")")
            echo -e "${CYAN}æ£€æµ‹åˆ° Letâ€™s Encrypt æºè¯ä¹¦: $domain${RESET}"
            print_cert_info "$p"
            found=1
        done
    fi

    # ---------------------------
    # 3) å…¼å®¹æ—§ç‰ˆ derper certdir
    # ---------------------------
    if [[ -d "/var/lib/derper/certs" ]]; then
        certs2=(/var/lib/derper/certs/*.crt)
        if [[ -e "${certs2[0]}" ]]; then
            info "æ£€æµ‹åˆ° /var/lib/derper/certs ä¸­çš„è¯ä¹¦"
            for c in /var/lib/derper/certs/*.crt; do
                print_cert_info "$c"
            done
            found=1
        fi
    fi

    # ---------------------------
    # æ— è¯ä¹¦
    # ---------------------------
    if [[ $found -eq 0 ]]; then
        warn "æœªæ£€æµ‹åˆ°ä»»ä½•è¯ä¹¦ï¼ˆDERP / Letâ€™s Encryptï¼‰"
    fi

    _pause; menu
}

uninstall_project(){
    show_header
    echo -e "${YELLOW}æœ¬æ“ä½œå°†å½»åº•å¸è½½æœ¬é¡¹ç›®ï¼Œå¹¶æ¸…ç†æ‰€æœ‰ç›¸å…³æ–‡ä»¶ï¼ˆåŒ…æ‹¬ Goã€Certbotã€DERPï¼‰ã€‚${RESET}"
    echo -e "${YELLOW}æ³¨æ„ï¼šå¸è½½åç³»ç»Ÿå°†ç«‹å³é‡å¯ï¼${RESET}"
    echo
    read -rp "è¯·è¾“å…¥ yes ç¡®è®¤å¸è½½: " yn
    [[ "$yn" != "yes" ]] && { info "å·²å–æ¶ˆå¸è½½"; _pause; menu; }

    echo
    info "å¼€å§‹å¸è½½æœ¬é¡¹ç›®..."

    #############################
    # 1. åœæ­¢ derper æœåŠ¡
    #############################
    if systemctl status "$DERP_SERVICE" >/dev/null 2>&1; then
        info "åœæ­¢ derper æœåŠ¡..."
        systemctl stop "$DERP_SERVICE" 2>/dev/null || true
        systemctl disable "$DERP_SERVICE" 2>/dev/null || true
    else
        warn "æœªæ£€æµ‹åˆ° derper.serviceï¼ˆå¯èƒ½å·²åˆ é™¤ï¼‰"
    fi

    #############################
    # 2. åˆ é™¤ derper systemd å•å…ƒ
    #############################
    if [[ -f "$DERP_SYSTEMD_UNIT" ]]; then
        info "åˆ é™¤ systemd å•å…ƒæ–‡ä»¶: $DERP_SYSTEMD_UNIT"
        rm -f "$DERP_SYSTEMD_UNIT"
    fi
    systemctl daemon-reload || true
    systemctl reset-failed || true

    #############################
    # 3. åˆ é™¤ derper æ–‡ä»¶ä¸ç›®å½•
    #############################
    for p in /usr/local/bin/derper /opt/derper /var/lib/derper; do
        if [[ -e "$p" ]]; then
            info "åˆ é™¤: $p"
            rm -rf "$p"
        fi
    done

    #############################
    # 4. åˆ é™¤ derper è‡ªåŠ¨ç»­æœŸ cron
    #############################
    if [[ -f "/etc/cron.d/derper-auto-renew" ]]; then
        info "åˆ é™¤è‡ªåŠ¨ç»­æœŸä»»åŠ¡: /etc/cron.d/derper-auto-renew"
        rm -f /etc/cron.d/derper-auto-renew
    fi

    #############################
    # 5. åˆ é™¤ derper deploy-hook
    #############################
    if [[ -f "/usr/local/bin/derp-cert-copy.sh" ]]; then
        info "åˆ é™¤è¯ä¹¦åŒæ­¥è„šæœ¬: /usr/local/bin/derp-cert-copy.sh"
        rm -f /usr/local/bin/derp-cert-copy.sh
    fi

    #############################
    # 6. åˆ é™¤ DERP è¯ä¹¦ç›®å½•ï¼ˆä½ å®šä¹‰çš„ï¼‰
    #############################
    if [[ -d "/etc/derp/certs" ]]; then
        info "DERP ä½¿ç”¨çš„è¯ä¹¦ç›®å½•ï¼š/etc/derp/certs"
        read -rp "æ˜¯å¦åˆ é™¤è¯¥ç›®å½•ï¼Ÿ(é»˜è®¤: ä¸åˆ é™¤ï¼Œå›è½¦=ä¿ç•™ï¼Œè¾“å…¥ yes åˆ é™¤): " del_derp_cert
        if [[ "$del_derp_cert" == "yes" ]]; then
            rm -rf /etc/derp/certs
            info "å·²åˆ é™¤ /etc/derp/certs"
        else
            info "ä¿ç•™ /etc/derp/certs"
        fi
    fi

    #############################
    # 7. åˆ é™¤ Certbotï¼ˆé»˜è®¤åˆ é™¤ï¼Œæ— éœ€è¯¢é—®ï¼‰
    #############################
    info "åˆ é™¤ Certbotï¼ˆapt+æ’ä»¶ï¼‰..."
    apt remove -y certbot >/dev/null 2>&1 || true
    apt autoremove -y >/dev/null 2>&1 || true

    # pip3 æ’ä»¶
    for mod in certbot certbot-dns-cloudflare certbot-dns-aliyun certbot-dns-dnspod; do
        pip3 uninstall -y "$mod" >/dev/null 2>&1 || true
    done

    #############################
    # 8. åˆ é™¤ Let's Encrypt åŸŸåè¯ä¹¦ï¼ˆç›®å½•ç»“æ„ï¼‰
    #############################
    if [[ -d "/etc/letsencrypt/live" ]]; then
        echo
        warn "æ£€æµ‹åˆ° Letâ€™s Encrypt è¯ä¹¦ç›®å½•ï¼š/etc/letsencrypt"
        read -rp "æ˜¯å¦åˆ é™¤æ•´ä¸ª /etc/letsencrypt ä¸‹çš„è¯ä¹¦ï¼Ÿ(å›è½¦=ä¿ç•™, è¾“å…¥ yes=åˆ é™¤): " del_le
        if [[ "$del_le" == "yes" ]]; then
            rm -rf /etc/letsencrypt/{live,archive,renewal}
            info "å·²åˆ é™¤ Letâ€™s Encrypt è¯ä¹¦ç›®å½•"
        else
            info "ä¿ç•™ Letâ€™s Encrypt è¯ä¹¦ç›®å½•"
        fi
    fi

    #############################
    # 9. åˆ é™¤ Go ç¯å¢ƒï¼ˆé»˜è®¤åˆ é™¤ï¼‰
    #############################
    if [[ -d "/usr/local/go" ]]; then
        info "åˆ é™¤ Go è¿è¡Œç¯å¢ƒ..."
        rm -rf /usr/local/go
    fi
    rm -f /etc/profile.d/99-go-path.sh >/dev/null 2>&1 || true
    hash -r 2>/dev/null || true

    #############################
    # 10. åˆ é™¤æºç ç¼“å­˜
    #############################
    [[ -d "/tmp/tailscale-src" ]] && rm -rf /tmp/tailscale-src

    #############################
    # 11. æœ€åä¸€æ­¥ï¼šåˆ é™¤ td è‡ªèº«
    #############################
    info "åˆ é™¤ td å‘½ä»¤è‡ªèº«..."
    rm -f /usr/local/bin/td

    #############################
    # 12. é‡å¯ç³»ç»Ÿï¼ˆå¼ºåˆ¶ï¼Œæ— è¯¢é—®ï¼‰
    #############################
    echo
    echo -e "${GREEN}å¸è½½å®Œæˆï¼ç³»ç»Ÿå°†ç«‹å³é‡å¯ã€‚${RESET}"
    read -rp "æŒ‰å›è½¦é‡å¯ç³»ç»Ÿ..."
    reboot
}

# main
menu

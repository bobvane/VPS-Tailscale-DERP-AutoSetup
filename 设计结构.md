#!/usr/bin/env bash
set -euo pipefail
export LANG=zh_CN.UTF-8

############################################################
# 0. 基础变量 / 日志函数 / 配色
############################################################
# - log/info/success/warn/error
# - 定义颜色代码
# - exit trap 处理
# - 定义工具函数：check_root, check_cmd, port_free 等


############################################################
# 1. 全局行为与环境初始化区
############################################################
# - 检查 root
# - 检查 Debian 版本
# - 自动设置时区 Asia/Shanghai
# - 自动时间同步（chrony 或 systemd-timesyncd）
# - 初始化 UTF-8 环境
# - 可选：系统 apt upgrade / 安全更新


############################################################
# 2. 运行环境检查区（非破坏性）
############################################################
# - 检查 80/443 是否被占用 → 红色警告
# - 检查 DNS 是否为 100.100.2.136 / 100.100.2.138（阿里云内网 DNS）→ 红色
# - 检查 IPv4/IPv6
# - 检查是否已有 derper 在跑
# - 提醒可能影响 Let’s Encrypt 的环境因素


############################################################
# 3. 系统组件可选优化区（可跳过）
############################################################
# 3.1 安装常用工具（jq、curl、wget、socat 等）
# 3.2 设置国内 DNS（说明：有利于证书申请）
# 3.3 智能 BBR 优化模块（完整自动优先级逻辑）
# 3.4 虚拟内存 swap 1GB（可选）
# 3.5 sysctl 优化（连接跟踪、TCP 缓存、队列优化等）
# 3.6 CPU 性能模式 governor(performance)
# 注意：本段完全可跳过，不会中断脚本。


############################################################
# 4. 证书申请模块（核心）
############################################################
# 输入域名（强制）
# 验证 DNS 是否生效
# 自动选择 ACME（acme.sh）申请 Let’s Encrypt（HTTP-01）
# 自动释放端口（停止 nginx、caddy 等）
# 自动续期配置
# 失败自动 fallback → 自签证书（OpenSSL）
# 最终输出：
#   /etc/derper/cert.pem
#   /etc/derper/key.pem


############################################################
# 5. 下载并安装 derper 程序
############################################################
# - CPU 架构检测
# - 自动从 GitHub 获取最新 release
# - 国内镜像 fallback
# - 校验版本
# - 安装到 /usr/local/bin/derper


############################################################
# 6. 生成 DERP 配置文件（derp.yaml）
############################################################
# - 自动检测 IPv4 & IPv6
# - 用户输入 regionID（默认 901）
# - 域名写入
# - 证书路径写入
# - 启用 STUN（3478）
# - YAML 内容生成至：
#   /etc/derper/derp.yaml


############################################################
# 6.5 安装 td 模板工具（新增）
############################################################
# - 将仓库中的 td 文件复制到 /opt/derp/td
# - chmod +x /opt/derp/td
# - td 负责：
#    * 自动生成 region.json（如支持多 region）
#    * 生成新的 derp.yaml 模板
#    * 后续 update.sh 也需要用到 td
# - 如果用户以后修改 regionID，可重新执行 td 构建配置


############################################################
# 7. 安装 systemd 服务（derper.service）
############################################################
# 生成：
#   /etc/systemd/system/derper.service
#
# 内容包含：
#   ExecStart=/usr/local/bin/derper -config /etc/derper/derp.yaml
#   ExecReload=/bin/kill -HUP $MAINPID
#   Restart=always
#   RestartSec=3
#
# 然后：
#   systemctl daemon-reload
#   systemctl enable --now derper


############################################################
# 7.5 安装 update.sh 更新器（新增）
############################################################
# 复制 update.sh 到：
#   /usr/local/bin/derp-update
#
# update.sh 工作内容：
#   - 自动下载最新 derper 程序
#   - 自动备份旧版本
#   - 自动重新生成配置（如需要）
#   - 自动重启 systemd 服务
#   - 使用 td 生成 region 配置（如使用）
#
# 安装过程：
#   cp ./update.sh /usr/local/bin/derp-update
#   chmod +x /usr/local/bin/derp-update
#
# 最终提示：
#   使用 derp-update 可以随时更新 DERP 到最新版本。


############################################################
# 8. 防火墙配置（可选）
############################################################
# - 自动放行：
#   80 / 443 / 3478
# - 支持 ufw / firewalld / iptables


############################################################
# 9. 最终检查（证书 / region / IPv4/IPv6）
############################################################
# - 检查 derper 是否正在运行
# - 输出访问 URL 与 regionID
# - 输出 IPv4 / IPv6 状态
# - 输出证书有效性
# - 自动提示：将重启以加载新内核
# - 执行 reboot


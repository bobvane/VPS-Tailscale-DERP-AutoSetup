VPS-Tailscale-DERP-AutoSetup — 设计结构（最新版）

本文件用于描述本项目的整体架构、脚本之间的逻辑关系、运行流程，以及相关目录结构。适用于开发维护和理解项目行为逻辑。

============================================================

1. 项目整体结构

VPS-Tailscale-DERP-AutoSetup/
├── install_cn.sh # 主安装脚本（中国大陆优化版）
├── td # DERP 管理工具（交互式 CLI）
├── README.md # 项目介绍
└── 设计结构.md # 项目架构设计（本文件）

本项目主要功能：

在中国网络环境下自动部署 Tailscale DERP 中继节点

完整构建 derper（二进制已官方移除）

自动申请 SSL 证书（HTTP-01 或 DNS-01）

自动续期（cron）

一键管理工具 td

网络优化、BBR 优化、Swap 等可选模块

============================================================

2. install_cn.sh — 主安装脚本架构

install_cn.sh 是整个项目中最核心的脚本，负责从零开始部署 DERP 节点，并对系统进行必要的网络优化。

脚本共分为 7 个主模块：

第 1 段：环境初始化

设置 PATH 变量

定义格式化输出（颜色）

定义全局变量（DERP 工作目录、证书目录等）

输出启动日志

第 2 段：运行环境检查

必须 root

必须 Debian/Ubuntu

检查 80/443 端口占用

检查系统类型与版本

不修改任何系统内容。

第 3 段：系统优化（可选）

用户可选择跳过或执行该段。本段包含：

3.1 更新系统并安装基础组件

如 curl、git、dnsutils、chrony 等。

3.2 国内 DNS 修复（阿里云重点处理）

自动识别以下情况：

resolv.conf 被 systemd-resolved 强制管理

阿里云内部 DNS（100.100.100.100）

DNS 是否属于国外节点（如 8.8.8.8）

最终写入国内高可用 DNS：

223.5.5.5

183.60.83.19

同步 IPv6 DNS

3.3 BBR 自动启用（智能检测系统）

自动检测内核特性，自动选择：

BBRv2 + fq_codel（最优）

BBRv2 + fq

若不支持则自动安装 XanMod（v3→v2→v1 fallback）

最后兜底 BBRv1 + fq_codel

3.4 创建 Swap 1GB（仅无 Swap 时创建）
3.5 Sysctl 网络优化（DERP 专用）

写入 /etc/sysctl.d/99-derp-opt.conf，包括：

UDP 缓冲

icmp

keepalive

rp_filter

ip_local_port_range

default_qdisc=fq

完成后 sysctl --system 自动生效。

第 4 段：证书申请模块（核心）

支持两种模式：

HTTP-01

要求 80 端口开放。

DNS-01

支持三家 DNS：

Cloudflare

Aliyun

DNSPod

支持通配符域名 *.domain.com。

申请成功后，自动复制到：

/etc/derp/certs/<domain>.crt
/etc/derp/certs/<domain>.key

并且自动生成 deploy-hook：

/usr/local/bin/derp-cert-copy.sh

续期后自动同步证书并重启 derper。

第 5 段：编译 derper（二进制官方已下架）

流程：

自动从 golang.google.cn 获取最新 Go 版本

从 GitHub（tailscale/tailscale）克隆源码

构建 cmd/derper

输出到：

/usr/local/bin/derper

第 6 段：部署 systemd 服务

生成服务文件：

/etc/systemd/system/derper.service

包含：

ExecStart=/usr/local/bin/derper
-a :443
--hostname=<DOMAIN>
--certmode=manual
--certdir=/etc/derp/certs
--stun

服务行为：

systemctl daemon-reload

systemctl enable --now derper

检查 TCP 443 与 UDP 3478 监听

第 7 段：安装 td 管理工具 + 自动续期

下载 td → /usr/local/bin/td

赋予权限

创建自动续期任务：

/etc/cron.d/derper-auto-renew
内容：

0 */12 * * * root certbot renew --quiet

最后提示用户重启系统。

============================================================

3. td — DERP 管理工具（最新版 v2.1）

td 是一个功能完整的交互式 CLI 管理器，包含以下菜单：

查看 DERP 服务状态

重启 DERP（未运行时自动启动）

停止 DERP

生成 DERP Map（输出完整 JSON 文件，用户直接复制替换）

查看证书与到期时间（含中文过期天数）

卸载本项目（多项清理，td 最后自删）

退出

td 模块说明
1. 查看状态

使用 systemctl status + journalctl。

2. 重启服务

如果 derper 不存在 → 自动提示
如果 derper 已停止 → 自动启动

3. 停止服务

停止并禁用，不会被自动重启。

4. 生成 DERP Map

输出完整 Tailscale JSON：

OmitDefaultRegions（默认 true）

Regions（根据用户输入生成）

Acls（全放行）

SSH（默认规则）

用户复制结果 → 全部替换：

https://login.tailscale.com/admin/acls/file

即可启用自建 DERP。

5. 查看证书

显示：

DERP 正在使用证书

Let’s Encrypt 源证书

Not Before、Not After（中文）

剩余天数

6. 卸载（完整流程）

内容：

停止 & 禁用 derper

删除 derper.service

删除 derper 二进制

删除 /opt/derper

删除 /var/lib/derper

删除自动续期 cron

删除 derp-cert-copy.sh

询问用户是否删除证书目录

最后删除 /usr/local/bin/td 自身

完成后强制要求重启

============================================================

4. 项目文件最终布局

/usr/local/bin/derper
/usr/local/bin/td

/etc/derp/certs/
├── <domain>.crt
└── <domain>.key

/etc/letsencrypt/live/<domain>/
/etc/systemd/system/derper.service

/opt/derper/
/var/lib/derper/

/etc/cron.d/derper-auto-renew

============================================================

5. install_cn.sh 与 td 的功能关系
功能	install_cn.sh	td
安装 derper	✔	✘
启动 derper	✔	✔
查看状态	✘	✔
生成 DERP Map	✘	✔
申请证书	✔	✘
查看证书	✘	✔
卸载	✘	✔
自动续期	✔	✘

两者形成完整闭环。

============================================================

6. 卸载逻辑（最新版 v2.1）

默认删除：

derper.service

derper

/opt/derper

/var/lib/derper

/etc/cron.d/derper-auto-renew

/usr/local/bin/derp-cert-copy.sh

可选删除（提示）：

/etc/derp/certs（默认保留）

最后：

删除 /usr/local/bin/td

强制提示重启系统

============================================================

7. 总结

本项目提供：

一键 DERP 部署脚本（中国优化）

自带网络优化（BBR / Swap / sysctl）

自动证书申请 + 自动续期

自动编译 derper

完整 systemd 管理

交互式管理工具 td

完整卸载流程

项目已具备高可用性、可移植性、可维护性，是目前最完整的一键 DERP 部署方案之一。

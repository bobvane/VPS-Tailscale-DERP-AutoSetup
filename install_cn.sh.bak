#!/usr/bin/env bash
# install_cn.sh v4.2-fixed
# ç›®çš„ï¼šä¿®å¤å¡ä½ã€å¼ºåˆ¶åŸŸåå¿…é¡»è¾“å…¥ + æ¢å¤å¯æŽ§ Go ä¸‹è½½é€»è¾‘
# ä½œè€…: bobvane
# è¯´æ˜Žï¼šåœ¨ä½ çŽ°æœ‰çš„ v4.x åŸºç¡€ä¸Šä»…åšå¿…è¦ä¿®å¤ä¸Žå¢žå¼ºæŽ§åˆ¶ï¼Œä¸æ”¹å˜å·²ç¨³å®šé€»è¾‘ã€‚

set -euo pipefail
export LANG=zh_CN.UTF-8

# ---------- é¢œè‰² ----------
GREEN=$(tput setaf 2 2>/dev/null || echo "")
YELLOW=$(tput setaf 3 2>/dev/null || echo "")
RED=$(tput setaf 1 2>/dev/null || echo "")
CYAN=$(tput setaf 6 2>/dev/null || echo "")
RESET=$(tput sgr0 2>/dev/null || echo "")

info(){ echo -e "${GREEN}[INFO]${RESET} $*"; }
warn(){ echo -e "${YELLOW}[WARN]${RESET} $*"; }
err(){ echo -e "${RED}[ERROR]${RESET} $*"; }

# ---------- å¯é…ç½®é¡¹ï¼ˆçŽ¯å¢ƒå˜é‡å¯è¦†ç›–ï¼‰ ----------
# å¦‚æžœæƒ³ä½¿ç”¨è‡ªå®šä¹‰ Go ä¸‹è½½é“¾æŽ¥ï¼Œåœ¨è¿è¡Œè„šæœ¬å‰ export GO_URL_OVERRIDE=...
GO_VER="${GO_VER:-go1.25.4}"
DEFAULT_GO_URL="https://go.dev/dl/${GO_VER}.linux-amd64.tar.gz"
ALIYUN_GO_URL="https://mirrors.aliyun.com/golang/${GO_VER}.linux-amd64.tar.gz"
TUNA_GO_URL="https://mirrors.tuna.tsinghua.edu.cn/golang/${GO_VER}.linux-amd64.tar.gz"
HUAWEI_GO_URL="https://mirrors.huaweicloud.com/golang/${GO_VER}.linux-amd64.tar.gz"
GO_URL_OVERRIDE="${GO_URL_OVERRIDE:-}"
SKIP_GO="${SKIP_GO:-0}"  # è®¾ç½®ä¸º1å¯è·³è¿‡Goå®‰è£…ï¼ˆä¾‹å¦‚ä½ å·²æ‰‹åŠ¨å®‰è£…ï¼‰

REPO_RAW="https://raw.githubusercontent.com/bobvane/VPS-Tailscale-DERP-AutoSetup/main"
GHPROXY_GIT_PREFIX="https://ghproxy.cn/https://github.com"

DERP_CERTDIR="/var/lib/derper/certs"
DERP_WORKDIR="/opt/derper"
TD_PATH="/usr/local/bin/td"
CRON_FILE="/etc/cron.d/derper-renew"

# ---------- æƒé™/ç³»ç»Ÿæ£€æŸ¥ ----------
if [[ $EUID -ne 0 ]]; then
  err "è¯·ä½¿ç”¨ root ç”¨æˆ·æ‰§è¡Œæ­¤è„šæœ¬ã€‚"
  exit 1
fi

if ! grep -q "VERSION_ID=\"12\"" /etc/os-release 2>/dev/null; then
  warn "æ£€æµ‹åˆ°éž Debian 12 ç³»ç»Ÿï¼Œè„šæœ¬è®¾è®¡ä»¥ Debian 12 ä¸ºä¸»ï¼Œç»§ç»­å¯èƒ½æœ‰é£Žé™©ã€‚"
  read -rp "ä»è¦ç»§ç»­æ‰§è¡Œå—ï¼Ÿ(y/N): " _yn
  [[ "${_yn,,}" == "y" ]] || { info "å–æ¶ˆæ‰§è¡Œ"; exit 1; }
fi

# ---------- åŸºç¡€å‡½æ•° ----------
_safe_wait_for_file(){
  # usage: _safe_wait_for_file /path/to/file timeout_seconds
  local file="$1"; local timeout="${2:-60}"; local n=0
  while [[ ! -f "$file" && $n -lt $timeout ]]; do
    sleep 1; n=$((n+1))
  done
  [[ -f "$file" ]]
}

detect_public_ip(){
  local ip
  ip="$(curl -fsSL https://ifconfig.me 2>/dev/null || true)"
  if [[ -z "$ip" ]]; then
    ip="$(curl -fsSL https://ipinfo.io/ip 2>/dev/null || true)"
  fi
  echo "$ip"
}

# ---------- ç”¨æˆ·è¾“å…¥ï¼šåŸŸåå¿…é¡»è¾“å…¥ï¼ˆå¾ªçŽ¯ç›´åˆ°æœ‰æ•ˆï¼‰ ----------
while true; do
  read -rp "è¯·è¾“å…¥ç»‘å®šçš„åŸŸåï¼ˆå¿…é¡»ï¼Œä¾‹: derp.bobvane.topï¼‰: " DOMAIN
  DOMAIN="${DOMAIN// /}"  # trim spaces
  if [[ -z "$DOMAIN" ]]; then
    echo -e "${YELLOW}åŸŸåä¸èƒ½ä¸ºç©ºï¼Œè¯·è¾“å…¥ã€‚${RESET}"
    continue
  fi
  # ç®€å•æ ¡éªŒï¼šåŒ…å«ç‚¹ï¼Œä¸”é•¿åº¦>3
  if [[ "${#DOMAIN}" -lt 4 || "$DOMAIN" != *.* ]]; then
    echo -e "${YELLOW}åŸŸåæ ¼å¼çœ‹èµ·æ¥ä¸å¯¹ï¼Œè¯·é‡æ–°è¾“å…¥${RESET}"
    continue
  fi
  # å°è¯•è§£æž A è®°å½•
  DIG_IP="$(dig +short A "$DOMAIN" | tail -n1 || true)"
  if [[ -z "$DIG_IP" ]]; then
    echo -e "${YELLOW}åŸŸåæœªè§£æžåˆ° A è®°å½• (dig è¿”å›žç©º)ã€‚${RESET}"
    read -rp "æ˜¯å¦ä»ç„¶ç»§ç»­ï¼ˆé€šå¸¸éœ€è¦å…ˆæŠŠåŸŸåè§£æžåˆ°æœåŠ¡å™¨ï¼‰ï¼Ÿ(y/N): " _c
    if [[ "${_c,,}" == "y" ]]; then
      break
    else
      continue
    fi
  fi
  # è‡ªåŠ¨æ£€æµ‹æœ¬æœºå…¬ç½‘IP
  PUB_IP="$(detect_public_ip)"
  if [[ -n "$PUB_IP" && "$DIG_IP" != "$PUB_IP" ]]; then
    echo -e "${YELLOW}æ³¨æ„: åŸŸå $DOMAIN è§£æžåˆ° $DIG_IPï¼Œæ£€æµ‹åˆ°æœ¬æœºå…¬ç½‘ IP ä¸º $PUB_IPã€‚${RESET}"
    read -rp "è§£æžä¸åŒ¹é…ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ(y/N): " _c2
    if [[ "${_c2,,}" == "y" ]]; then
      break
    else
      continue
    fi
  fi
  # all good (or user confirmed)
  break
done

# å…¬ç½‘IPï¼ˆå¯é€‰è¾“å…¥ï¼‰
read -rp "è¯·è¾“å…¥æœåŠ¡å™¨å…¬ç½‘ IPï¼ˆå¯ç•™ç©ºè‡ªåŠ¨æ£€æµ‹ï¼‰: " SERVER_IP
if [[ -z "$SERVER_IP" ]]; then
  SERVER_IP="$(detect_public_ip || true)"
fi
info "åŸŸå: $DOMAIN"
info "æœåŠ¡å™¨å…¬ç½‘ IP: ${SERVER_IP:-(æœªæ£€æµ‹åˆ°)}"

# ---------- å®‰è£…/å‡†å¤‡çŽ¯å¢ƒï¼ˆä¿æŒä¹‹å‰ç¨³å®šé€»è¾‘ï¼‰ ----------
info "ç³»ç»Ÿæ›´æ–° & å®‰è£…åŸºç¡€ä¾èµ–..."
apt update -y
apt install -y curl wget git jq dnsutils socat tar ca-certificates bc lsb-release unzip certbot chrony

info "è®¾ç½®æ—¶åŒº Asia/Shanghaiï¼Œå¯ç”¨ chrony åŒæ­¥..."
timedatectl set-timezone Asia/Shanghai || true
systemctl enable chrony || true
systemctl restart chrony || true

info "å¯ç”¨ BBR (è‹¥æ”¯æŒ)..."
if ! grep -q "net.ipv4.tcp_congestion_control" /etc/sysctl.conf 2>/dev/null; then
  cat >>/etc/sysctl.conf <<'EOF'
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr
EOF
  sysctl --system >/dev/null 2>&1 || true
fi

# ---------- tailscale å®‰è£… ----------
info "å®‰è£… tailscaleï¼ˆå®˜æ–¹æºï¼‰..."
curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.noarmor.gpg \
  | tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.tailscale-keyring.list \
  | tee /etc/apt/sources.list.d/tailscale.list >/dev/null
apt update -y
apt install -y tailscale || true

# ---------- Go å®‰è£…ï¼ˆå¯æŽ§ï¼‰ ----------
if [[ "${SKIP_GO}" == "1" ]]; then
  info "SKIP_GO=1ï¼Œè·³è¿‡ Go å®‰è£…ï¼ˆå‡è®¾å·²å®‰è£…æˆ–ä½ å°†æ‰‹åŠ¨å¤„ç†ï¼‰"
else
  # ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è¦†ç›–çš„ URL
  if [[ -n "${GO_URL_OVERRIDE}" ]]; then
    GO_URL="${GO_URL_OVERRIDE}"
  else
    # ä¼˜å…ˆç”¨é˜¿é‡Œäº‘é•œåƒï¼ˆå›½å†…çŽ¯å¢ƒä¼˜å…ˆï¼‰
    GO_URL="${ALIYUN_GO_URL}"
  fi
  info "å‡†å¤‡ä¸‹è½½ Goï¼š${GO_URL}"
  if wget -q -O /tmp/go.tar.gz "${GO_URL}"; then
    rm -rf /usr/local/go
    tar -C /usr/local -xzf /tmp/go.tar.gz
    echo 'export PATH=/usr/local/go/bin:$PATH' > /etc/profile.d/99-go-path.sh
    export PATH=/usr/local/go/bin:$PATH
    info "Go å·²å®‰è£…ï¼š$(go version || true)"
  else
    warn "Go ä¸‹è½½å¤±è´¥ï¼ˆ${GO_URL}ï¼‰ã€‚ä½ å¯ä»¥æ‰‹åŠ¨è®¾ç½® GO_URL_OVERRIDE å†è¯•æˆ–æ‰‹åŠ¨å®‰è£… Goã€‚è„šæœ¬å°†ç»§ç»­ï¼ˆå¯èƒ½éœ€è¦ Go ä»…åœ¨æºç ç¼–è¯‘ derper æ—¶ä½¿ç”¨ï¼‰ã€‚"
  fi
fi

# ---------- èŽ·å–/å®‰è£… derperï¼ˆä¿æŒæ—§é€»è¾‘ï¼šå…ˆå°è¯•å®˜æ–¹åŒ…ï¼Œå†æºç ç¼–è¯‘ï¼‰ ----------
info "å®‰è£… derperï¼ˆå°è¯•å®˜æ–¹åŒ…ï¼Œå¤±è´¥æ—¶èµ°æºç ç¼–è¯‘ï¼‰..."
mkdir -p "${DERP_WORKDIR}" "${DERP_CERTDIR}"
cd "${DERP_WORKDIR}" || true

# å°è¯•å®˜æ–¹åŒ… downloadï¼ˆè‹¥å®˜æ–¹æ²¡æœ‰æä¾› derper äºŒè¿›åˆ¶è¿™é‡Œå¯èƒ½å¤±è´¥ï¼Œå›žé€€æºç ç¼–è¯‘ï¼‰
DERPER_TGZ_URL="https://ghproxy.cn/https://github.com/tailscale/tailscale/releases/latest/download/derper_linux_amd64.tgz"
info "å°è¯•ä½¿ç”¨ï¼š${DERPER_TGZ_URL}"
if wget -q -O derper.tgz "${DERPER_TGZ_URL}"; then
  tar -xzf derper.tgz 2>/dev/null || true
  if [[ -f ./derper ]]; then
    cp ./derper /usr/local/bin/derper
    chmod +x /usr/local/bin/derper
    info "å·²å®‰è£… derperï¼ˆå®˜æ–¹åŒ…ï¼‰"
  fi
fi

# è‹¥å®˜æ–¹åŒ…æœªæˆåŠŸï¼Œåˆ™æºç ç¼–è¯‘
if ! command -v /usr/local/bin/derper >/dev/null 2>&1; then
  warn "æœªæ£€æµ‹åˆ° derper äºŒè¿›åˆ¶ï¼Œå‡†å¤‡æºç ç¼–è¯‘ï¼ˆéœ€è¦ goï¼‰..."
  rm -rf /tmp/tailscale-src && mkdir -p /tmp/tailscale-src
  if ! git clone --depth=1 "${GHPROXY_GIT_PREFIX}/tailscale/tailscale.git" /tmp/tailscale-src; then
    err "å…‹éš† tailscale æºç å¤±è´¥"
  else
    if command -v go >/dev/null 2>&1; then
      cd /tmp/tailscale-src/cmd/derper || true

      # âœ… è®¾ç½®å›½å†… Go æ¨¡å—ä»£ç†ï¼Œé˜²æ­¢ä¾èµ–ä¸‹è½½å¡æ­»
      info "è®¾ç½®å›½å†… Go æ¨¡å—ä»£ç†ä»¥åŠ é€Ÿä¾èµ–ä¸‹è½½..."
      /usr/local/go/bin/go env -w GOPROXY=https://goproxy.cn,direct
      /usr/local/go/bin/go env -w GOSUMDB=off

      /usr/local/go/bin/go build -o /usr/local/bin/derper . || { err "derper ç¼–è¯‘å¤±è´¥"; }
      chmod +x /usr/local/bin/derper || true
      info "derper å·²ä»Žæºç ç¼–è¯‘å®‰è£…"
    else
      warn "ç³»ç»Ÿæœªæ£€æµ‹åˆ° goï¼Œæºç ç¼–è¯‘æ— æ³•æ‰§è¡Œï¼ˆéœ€æ‰‹åŠ¨å®‰è£… go æˆ–ä½¿ç”¨å®˜æ–¹åŒ…ï¼‰ã€‚"

    fi
  fi
fi

# ---------- è¯ä¹¦ç”³è¯·ï¼ˆä½¿ç”¨ certbot HTTP-01, 80ç«¯å£ï¼‰ï¼Œå¹¶ç¡®ä¿å†™å…¥å†å¯åŠ¨ derper ----------
info "ä¸º ${DOMAIN} ç”³è¯· Let's Encrypt è¯ä¹¦ï¼ˆä½¿ç”¨ HTTP-01 éªŒè¯ï¼Œ80ç«¯å£ï¼‰..."

# æ£€æŸ¥ç«¯å£ 80 æ˜¯å¦è¢«å ç”¨
if ss -tuln | grep -q ':80 '; then
  err "80ç«¯å£å½“å‰è¢«å ç”¨ï¼Œè¯·å…ˆé‡Šæ”¾åŽå†è¿è¡Œæœ¬è„šæœ¬ã€‚"
  ss -tuln | grep ':80 ' || true
  exit 1
fi

# ç¡®ä¿è¯ä¹¦ç›®å½•å­˜åœ¨
mkdir -p /etc/letsencrypt/live/${DOMAIN}

# å°è¯•ç­¾å‘è¯ä¹¦ï¼ˆæœ€å¤š3æ¬¡é‡è¯•ï¼‰
MAX_TRY=3
TRY=1
while [[ ${TRY} -le ${MAX_TRY} ]]; do
  info "certbot æ­£åœ¨å°è¯•ç­¾å‘ (${TRY}/${MAX_TRY}) ..."
  if certbot certonly --standalone --preferred-challenges http \
      -d "${DOMAIN}" --agree-tos -m "admin@${DOMAIN}" --non-interactive; then
    info "âœ… è¯ä¹¦ç”³è¯·æˆåŠŸ"
    break
  else
    warn "âŒ ç¬¬ ${TRY} æ¬¡ç­¾å‘å¤±è´¥"
    ((TRY++))
    sleep 5
  fi
done

# æ£€æŸ¥æ˜¯å¦ç­¾å‘æˆåŠŸï¼Œå¦åˆ™é€€å‡º
if [[ ! -f "/etc/letsencrypt/live/${DOMAIN}/fullchain.pem" ]]; then
  err "è¯ä¹¦ç­¾å‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥ DNSã€80ç«¯å£æˆ–é˜²ç«å¢™è®¾ç½®ã€‚"
  exit 1
fi

# æ‹·è´è¯ä¹¦åˆ° derper ç›®å½•
info "å¤åˆ¶è¯ä¹¦åˆ° DERP å·¥ä½œç›®å½•..."
mkdir -p /var/lib/derper/certs
cp "/etc/letsencrypt/live/${DOMAIN}/fullchain.pem" "/var/lib/derper/certs/${DOMAIN}.crt"
cp "/etc/letsencrypt/live/${DOMAIN}/privkey.pem" "/var/lib/derper/certs/${DOMAIN}.key"
chmod 600 /var/lib/derper/certs/*
chown root:root /var/lib/derper/certs/*

# éªŒè¯è¯ä¹¦æ–‡ä»¶å­˜åœ¨
if [[ ! -f "/var/lib/derper/certs/${DOMAIN}.crt" || ! -f "/var/lib/derper/certs/${DOMAIN}.key" ]]; then
  err "è¯ä¹¦æ–‡ä»¶å¤åˆ¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥è·¯å¾„ /var/lib/derper/certs/"
  exit 1
fi

# å¯åŠ¨ DERP æœåŠ¡
info "ðŸš€ å¯åŠ¨ derper æœåŠ¡..."
systemctl daemon-reload
systemctl enable derper --now
sleep 2

if systemctl is-active --quiet derper; then
  info "âœ… DERP æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
else
  err "âŒ DERP å¯åŠ¨å¤±è´¥ï¼Œè¯·ä½¿ç”¨ journalctl -u derper æŸ¥çœ‹æ—¥å¿—"
  exit 1
fi

# ---------- åˆ›å»º systemd unitï¼ˆcertdir å·²å­˜åœ¨æˆ–è‡ªç­¾å·²ç”Ÿæˆï¼‰ ----------
info "åˆ›å»º systemd å•å…ƒ /etc/systemd/system/derper.service ..."
cat >/etc/systemd/system/derper.service <<EOF
[Unit]
Description=Tailscale DERP relay server
After=network.target

[Service]
ExecStart=/usr/local/bin/derper --hostname ${DOMAIN} --certmode manual --certdir ${DERP_CERTDIR} --stun --a ":443"
WorkingDirectory=/var/lib/derper
AmbientCapabilities=CAP_NET_BIND_SERVICE
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable derper

# ---------- å®‰è£… tdï¼ˆä¿è¯ heredoc æ­£ç¡®å…³é—­ï¼Œé¿å…å¡æ­»ï¼‰ ----------
info "å®‰è£… td ç®¡ç†å·¥å…·ï¼ˆ/usr/local/bin/tdï¼‰..."
cat >"${TD_PATH}" <<'EOF'
#!/usr/bin/env bash
# td v1.5 ç®€åŒ–ç‰ˆï¼ˆäº¤äº’å¼ï¼‰
GREEN=$(tput setaf 2 2>/dev/null || echo "")
YELLOW=$(tput setaf 3 2>/dev/null || echo "")
RED=$(tput setaf 1 2>/dev/null || echo "")
CYAN=$(tput setaf 6 2>/dev/null || echo "")
RESET=$(tput sgr0 2>/dev/null || echo "")

info(){ echo -e "${GREEN}[INFO]${RESET} $*"; }
warn(){ echo -e "${YELLOW}[WARN]${RESET} $*"; }
err(){ echo -e "${RED}[ERROR]${RESET} $*"; }

DERP_SERVICE="derper"
TAILSCALE_SERVICE="tailscaled"
DERP_CERTDIR="/var/lib/derper/certs"
DERP_SYSUNIT="/etc/systemd/system/derper.service"

_pause(){ read -rp $'\næŒ‰å›žè½¦è¿”å›ž'; }

menu(){
  clear
  echo -e "${CYAN}=== td v1.5 â€” DERP & Tailscale ç®¡ç†å·¥å…· ===${RESET}"
  echo "1) æŸ¥çœ‹ DERP æœåŠ¡çŠ¶æ€"
  echo "2) é‡å¯ DERP æœåŠ¡"
  echo "3) åœæ­¢ DERP æœåŠ¡"
  echo "4) æŸ¥çœ‹ tailscaled çŠ¶æ€"
  echo "5) ç”Ÿæˆ derpmap.json (å¹¶ä¿å­˜åˆ° /etc/tailscale/derpmap.json)"
  echo "6) æŸ¥çœ‹è¯ä¹¦ & åˆ°æœŸæ—¶é—´"
  echo "7) æ³¨å†Œ Tailscale å®¢æˆ·ç«¯ (tailscale up)"
  echo "8) è§¦å‘ certbot renew å¹¶é‡å¯ derper"
  echo "9) å¸è½½æœ¬é¡¹ç›®ï¼ˆæ¸…ç†æ–‡ä»¶ï¼‰"
  echo "0) é€€å‡º"
  read -rp "è¯·é€‰æ‹©: " opt
  case "$opt" in
    1) systemctl status ${DERP_SERVICE} --no-pager || true; _pause; menu ;;
    2) systemctl restart ${DERP_SERVICE} && info "å·²é‡å¯"; _pause; menu ;;
    3) systemctl stop ${DERP_SERVICE} && info "å·²åœæ­¢"; _pause; menu ;;
    4) systemctl status ${TAILSCALE_SERVICE} --no-pager || true; if command -v tailscale >/dev/null 2>&1; then tailscale status || true; fi; _pause; menu ;;
    5) read -rp "RegionID (é»˜è®¤ 900): " r; r=${r:-900}; read -rp "RegionCode (é»˜è®¤ CN): " rc; rc=${rc:-CN}; read -rp "DERP ä¸»æœº (åŸŸå): " host; read -rp "DERP IPv4: " ip; cat >/etc/tailscale/derpmap.json <<EOM
{"Regions": {"${r}": {"RegionID": ${r}, "RegionCode": "${rc}", "RegionName": "China Private DERP", "Nodes": [{"Name": "${host}", "RegionID": ${r}, "HostName": "${host}", "IPv4": "${ip}", "STUNPort": 3478, "DERPPort": 443}]}}}
EOM
      info "å·²ç”Ÿæˆ /etc/tailscale/derpmap.json"; _pause; menu ;;
    6) ls -l ${DERP_CERTDIR} 2>/dev/null || true; if [[ -f ${DERP_CERTDIR}/*.crt ]]; then openssl x509 -in ${DERP_CERTDIR}/*.crt -noout -dates || true; fi; _pause; menu ;;
    7) systemctl start tailscaled 2>/dev/null || true; if ! command -v tailscale >/dev/null 2>&1; then err "æœªæ£€æµ‹åˆ° tailscale"; _pause; menu; fi; echo "å°†æ‰§è¡Œ: tailscale up --ssh"; read -rp "ç¡®è®¤æ‰§è¡Œå¹¶æ˜¾ç¤ºè®¤è¯é“¾æŽ¥ï¼Ÿ(y/N): " c; if [[ ${c,,} == "y" ]]; then tailscale up --ssh || true; fi; _pause; menu ;;
    8) if command -v certbot >/dev/null 2>&1; then certbot renew --quiet || warn "renew è¿”å›žéž0"; fi; systemctl restart ${DERP_SERVICE} || warn "é‡å¯å¤±è´¥"; _pause; menu ;;
    9) read -rp "ç¡®è®¤åˆ é™¤ derper ä¸Ž td æ–‡ä»¶? (y/N): " yn; if [[ ${yn,,} == "y" ]]; then systemctl stop derper 2>/dev/null || true; systemctl disable derper 2>/dev/null || true; rm -f /etc/systemd/system/derper.service; systemctl daemon-reload || true; rm -rf /opt/derper /var/lib/derper /usr/local/bin/derper /usr/local/bin/td /etc/tailscale/derpmap.json /etc/cron.d/derper-renew; info "å·²åˆ é™¤"; exit 0; fi; _pause; menu ;;
    0) exit 0 ;;
    *) echo "æ— æ•ˆé€‰é¡¹"; _pause; menu ;;
  esac
}
menu
EOF

# ç¡®ä¿ td å¯æ‰§è¡Œ
chmod +x "${TD_PATH}" || true
info "td å·²å®‰è£…åˆ° ${TD_PATH}"

# ---------- åˆ›å»ºè‡ªåŠ¨ç»­ç­¾ cron ---------- 
info "åˆ›å»ºè‡ªåŠ¨ç»­ç­¾ä»»åŠ¡ï¼ˆæ¯å‘¨ä¸€ 03:00ï¼‰..."
cat >"${CRON_FILE}" <<'EOF'
0 3 * * 1 root certbot renew --quiet && systemctl restart derper
EOF
chmod 644 "${CRON_FILE}" || true
info "è‡ªåŠ¨ç»­ç­¾å·²åˆ›å»º: ${CRON_FILE}"

# ---------- å¯åŠ¨ derper ----------
info "å°è¯•å¯åŠ¨ derper æœåŠ¡..."
systemctl start derper || true
sleep 2
if systemctl is-active --quiet derper; then
  info "âœ… derper å·²å¯åŠ¨å¹¶è¿è¡Œ"
else
  warn "derper æœªå®Œå…¨å¯åŠ¨ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—ï¼šjournalctl -u derper -n 50 --no-pager"
fi

info "è„šæœ¬æ‰§è¡Œç»“æŸã€‚è¯·è¿è¡Œ ${CYAN}td${RESET} å¹¶é€‰æ‹©â€œæ³¨å†Œ Tailscale å®¢æˆ·ç«¯â€ï¼ˆèœå•é¡¹ 7ï¼‰å®Œæˆç™»å½•ã€‚"
exit 0
